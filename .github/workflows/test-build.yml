name: Test Build

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]
  workflow_dispatch:

env:
  GODOT_VERSION: "4.5.1"
  EXPORT_NAME: "Crawler-Projektpraktikum"
  GODOT_DATA_PATH: "./godot"

jobs:
  export:
    name: ${{ matrix.name }} Export
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: Windows
            platform: "Windows Desktop"
            build_dir: windows
            extension: exe
          - name: Linux
            platform: "Linux"
            build_dir: linux
            extension: x86_64
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          lfs: true
      - name: Cache Godot and Export Templates
        id: cache-godot
        uses: actions/cache@v4
        with:
          path: godot
          key: godot-full-${{ env.GODOT_VERSION }}
      - name: Download Godot linux x86_64
        if: steps.cache-godot.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/godotengine/godot/releases/download/${{ env.GODOT_VERSION }}-stable/Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64.zip
          unzip Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64.zip -d godot
          chmod +x godot/Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64
      - name: Download Export Templates
        if: steps.cache-godot.outputs.cache-hit != 'true'
        run: |
          mkdir -p godot/export_templates/${{ env.GODOT_VERSION }}.stable
          wget https://github.com/godotengine/godot/releases/download/${{ env.GODOT_VERSION }}-stable/Godot_v${{ env.GODOT_VERSION }}-stable_export_templates.tpz
          tar -xzf Godot_v${{ env.GODOT_VERSION }}-stable_export_templates.tpz -C godot/export_templates/${{ env.GODOT_VERSION }}.stable
      - name: Verify Export Templates
        run: |
          echo "Checking for Windows templates..."
          ls -la godot/export_templates/${{ env.GODOT_VERSION }}.stable/ || echo "Templates directory not found"
          find godot/export_templates -name "*.exe" 2>/dev/null || echo "No .exe templates found"
      - name: Export Build
        run: |
          mkdir -p build/${{ matrix.build_dir }}
          godot/Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64 --headless --verbose --export-release "${{ matrix.platform }}" build/${{ matrix.build_dir }}/${{ env.EXPORT_NAME }}.${{ matrix.extension }}