name: Release (Build + Publish)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v0.1.0)"
        required: true
        type: string

env:
  GODOT_VERSION: 4.6
  EXPORT_NAME: Crawler-Projektpraktikum

jobs:
  build-windows:
    name: Build Windows
    runs-on: ubuntu-24.04
    env:
      RELEASE_TAG: ${{ github.event.inputs.tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          lfs: true
          ref: ${{ env.RELEASE_TAG }}
      - name: Setup Godot
        uses: ./.github/actions/setup-godot
        with:
          godot-version: ${{ env.GODOT_VERSION }}

      - name: Export Windows
        run: |
          mkdir -v -p build/windows dist
          ./Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64 --headless --verbose --export-release "Windows Desktop" "build/windows/$EXPORT_NAME.exe"

      - name: Package Windows
        run: |
          test -f "build/windows/$EXPORT_NAME.exe"
          test -f "build/windows/$EXPORT_NAME.pck"
          zip -j "dist/${EXPORT_NAME}-${RELEASE_TAG}-windows.zip" "build/windows/$EXPORT_NAME.exe" "build/windows/$EXPORT_NAME.pck"

      - name: Upload Windows package
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: dist/*.zip

  build-linux:
    name: Build Linux
    runs-on: ubuntu-24.04
    env:
      RELEASE_TAG: ${{ github.event.inputs.tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          lfs: true
          ref: ${{ env.RELEASE_TAG }}
      - name: Setup Godot
        uses: ./.github/actions/setup-godot
        with:
          godot-version: ${{ env.GODOT_VERSION }}

      - name: Export Linux
        run: |
          mkdir -v -p build/linux dist
          ./Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64 --headless --verbose --export-release "Linux" "build/linux/$EXPORT_NAME.x86_64"

      - name: Package Linux
        run: |
          test -f "build/linux/$EXPORT_NAME.x86_64"
          test -f "build/linux/$EXPORT_NAME.pck"
          chmod +x "build/linux/$EXPORT_NAME.x86_64"
          tar -czf "dist/${EXPORT_NAME}-${RELEASE_TAG}-linux.tar.gz" -C build/linux "$EXPORT_NAME.x86_64" "$EXPORT_NAME.pck"

      - name: Upload Linux package
        uses: actions/upload-artifact@v4
        with:
          name: linux
          path: dist/*.tar.gz

  publish:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux]
    permissions:
      contents: write
    env:
      RELEASE_TAG: ${{ github.event.inputs.tag || github.ref_name }}
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: List release assets
        run: ls -la dist/** || true

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TAG }}
          generate_release_notes: true
          files: |
            dist/**
