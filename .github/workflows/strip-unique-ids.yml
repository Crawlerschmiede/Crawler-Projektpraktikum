name: Strip unique_id (non-dev branches)

on:
  push:
    # run on all branches except dev
    branches-ignore:
      - 'dev'
  pull_request:
    branches-ignore:
      - 'dev'
  workflow_dispatch:

jobs:
  strip_ids:
    name: Strip unique_id from .tscn
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          ref: ${{ github.head_ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Strip unique_id from .tscn files
        run: |
          # remove editor-unique ids to avoid merge conflicts on non-dev branches
          git ls-files -z '*.tscn' | xargs -0 -r python3 scripts/strip_unique_id.py || true

      - name: Commit stripped .tscn files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: strip unique_id from .tscn (non-dev branches)"
          file_pattern: "*.tscn"
